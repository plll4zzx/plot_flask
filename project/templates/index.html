<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Excelæ•°æ®ä¸ç»˜å›¾å·¥å…·</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css">
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ace.js"></script>
    <style>
        .top-row {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }
    
        .table-area {
            flex: 1;
            border: 1px solid #ccc;
            padding: 10px;
        }
    
        .plot-area {
            flex: 1;
            border: 1px solid #ccc;
            padding: 10px;
        }
    
        .bottom-row {
            display: flex;
            margin-top: 20px;
            gap: 20px;
        }
    
        .file-tree-container {
            width: 300px;
            border: 1px solid #ccc;
            padding: 10px;
            max-height: 500px;
            overflow: auto;
            font-family: monospace;
        }
    
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
    
        #editor {
            height: 400px;
            border: 1px solid #ccc;
        }
    
        #plotResult {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
            border: 1px solid #ddd;
            margin-top: 10px;
            display: block;
        }
    
        .plot-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
    
        #pdfFilename {
            width: 150px;
        }
    </style>
</head>


<body>

<!-- é¡¶éƒ¨åŒºåŸŸï¼šè¡¨æ ¼ + ç»˜å›¾ -->
<div class="top-row">
    <!-- ğŸ“Š è¡¨æ ¼åŒºåŸŸ -->
    <div class="table-area">
        <h3>ğŸ“Š æ•°æ®è¡¨æ ¼</h3>
        <div id="excelTable"></div>
    </div>

    <!-- ğŸ“ˆ ç»˜å›¾åŒºåŸŸ + ä¸‹è½½ -->
    <div class="plot-area">
        <div class="plot-header">
            <h3>ğŸ“ˆ ç»˜å›¾ç»“æœ</h3>
            <div>
                <input type="text" id="pdfFilename" placeholder="æ–‡ä»¶å">
                <button onclick="downloadPDF()" id="downloadBtn" disabled>ä¸‹è½½PDF</button>
            </div>
        </div>
        <img id="plotResult" src="" alt="ç»˜å›¾ç»“æœå°†åœ¨æ­¤æ˜¾ç¤º">
    </div>
</div>

<!-- åº•éƒ¨åŒºåŸŸï¼šæ–‡ä»¶æ ‘ + ç¼–è¾‘å™¨ -->
<div class="bottom-row">
    <!-- ğŸ“ æ–‡ä»¶æ ‘ -->
    <div class="file-tree-container">
        <h3 style="margin-top: 0;">ğŸ“ Python æ–‡ä»¶</h3>
        <input type="text" id="treeSearch" placeholder="æœç´¢â€¦" style="width: 90%; margin-bottom: 10px;" />
        <div id="fileTree"></div>
    </div>

    <!-- ğŸ§  ä»£ç ç¼–è¾‘å™¨ -->
    <div class="editor-container">
        <h3 style="margin-top: 0;">ğŸ§  ä»£ç ç¼–è¾‘åŒºåŸŸ</h3>
        <div id="editor"></div>
        <div style="margin-top: 10px;">
            <button onclick="submitData()">ç»˜å›¾</button>
            <button onclick="reloadSelectedCode()">é‡æ–°å¯¼å…¥ä»£ç </button>
        </div>
    </div>
</div>

<script>
let expandedFolders = new Set();
const editor = ace.edit("editor", {
    mode: "ace/mode/python",
    theme: "ace/theme/github",
});

// åˆå§‹åŒ–é»˜è®¤ä»£ç 
editor.setValue(`# è¯·åœ¨è¿™é‡Œè¾“å…¥ç»˜å›¾ä»£ç \nimport matplotlib.pyplot as plt`, -1);

const container = document.getElementById('excelTable');
const hot = new Handsontable(container, {
    data: Handsontable.helper.createSpreadsheetData(5,5),
    rowHeaders: true,
    colHeaders: true,
    contextMenu: true,
    licenseKey: 'non-commercial-and-evaluation'
});

// è·å–æ–‡ä»¶åˆ—è¡¨å‡½æ•°
function refreshFileList(){
    fetch('/list_code_files')
    .then(res => res.json())
    .then(files => {
        const selector = document.getElementById('fileSelector');
        selector.innerHTML = '<option value="" disabled selected>è¯·é€‰æ‹©.pyæ–‡ä»¶</option>';
        files.forEach(file => {
            let option = document.createElement('option');
            option.value = file;
            option.textContent = file;
            selector.appendChild(option);
        });
    });
}

document.getElementById('fileSelector').addEventListener('change', function(){
    const filename = this.value;
    fetch(`/get_code/${filename}`)
    .then(res => res.json())
    .then(res => {
        if(res.status === 'success'){
            editor.setValue(res.code, -1);
        } else {
            alert('åŠ è½½æ–‡ä»¶å¤±è´¥ï¼');
        }
    });
});

// æäº¤æ•°æ®ç»˜å›¾
function submitData() {
    fetch('/plot', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
            data: hot.getData(),
            code: editor.getValue()
        })
    })
    .then(res => res.json())
    .then(res => {
        if(res.status === 'success'){
            const img = document.getElementById('plotResult');
            img.src = res.image_url + '?' + new Date().getTime();
            document.getElementById('downloadBtn').disabled = false;
        }else{
            alert("ç»˜å›¾å¤±è´¥: " + res.error);
            document.getElementById('downloadBtn').disabled = true;
        }
    });
}

// ä¸‹è½½PDF
function downloadPDF() {
    const user_filename = document.getElementById('pdfFilename').value.trim() || 'plot_result';
    const url = `/download_latest_pdf?user_filename=${encodeURIComponent(user_filename)}`;

    const link = document.createElement('a');
    link.href = url;
    link.download = user_filename;  // é€šçŸ¥æµè§ˆå™¨è¿›è¡Œä¸‹è½½
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
function reloadSelectedCode() {
    const selector = document.getElementById('fileSelector');
    const selectedFile = selector.value;

    if (!selectedFile) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ª .py æ–‡ä»¶');
        return;
    }

    fetch(`/get_code/${selectedFile}`)
    .then(res => res.json())
    .then(res => {
        if (res.status === 'success') {
            editor.setValue(res.code, -1);  // -1 è¡¨ç¤ºå…‰æ ‡ä¸ç§»åŠ¨
        } else {
            alert('é‡æ–°åŠ è½½å¤±è´¥');
        }
    });
}
function renderTree(container, nodes, search = "", parentPath = "") {
    const ul = document.createElement('ul');
    ul.style.paddingLeft = '1em';

    for (const node of nodes) {
        const li = document.createElement('li');
        li.style.listStyle = 'none';

        const currentPath = parentPath ? `${parentPath}/${node.name}` : node.name;

        if (node.type === 'folder') {
            const folderToggle = document.createElement('span');
            folderToggle.textContent = 'ğŸ“ ' + node.name;
            folderToggle.style.cursor = 'pointer';

            const subContainer = document.createElement('div');
            subContainer.style.marginLeft = '1em';

            // æ˜¯å¦å±•å¼€
            const isExpanded = expandedFolders.has(currentPath);
            subContainer.style.display = isExpanded ? 'block' : 'none';

            folderToggle.onclick = function () {
                if (subContainer.style.display === 'none') {
                    subContainer.style.display = 'block';
                    expandedFolders.add(currentPath);
                } else {
                    subContainer.style.display = 'none';
                    expandedFolders.delete(currentPath);
                }
            };

            renderTree(subContainer, node.children, search, currentPath);

            if (subContainer.innerHTML.trim() !== '') {
                li.appendChild(folderToggle);
                li.appendChild(subContainer);
                ul.appendChild(li);
            }

        } else if (node.type === 'file') {
            const match = search === "" || node.name.toLowerCase().includes(search.toLowerCase());
            if (match) {
                const fileLink = document.createElement('a');
                fileLink.href = '#';
                fileLink.textContent = 'ğŸ“„ ' + node.name;
                fileLink.style.display = 'block';
                fileLink.onclick = function () {
                    loadFileContent(node.path);
                    return false;
                };
                li.appendChild(fileLink);
                ul.appendChild(li);
            }
        }
    }

    container.appendChild(ul);
}


function loadCodeTree(searchText = "") {
    fetch('/code_tree')
        .then(res => res.json())
        .then(tree => {
            const container = document.getElementById('fileTree');
            container.innerHTML = '';
            renderTree(container, tree, searchText);
        });
}

// æœç´¢æ¡†ç›‘å¬
document.getElementById('treeSearch').addEventListener('input', function () {
    const searchText = this.value;
    loadCodeTree(searchText);
});

function loadFileContent(filePath) {
    fetch(`/get_code/${filePath}`)
        .then(res => res.json())
        .then(res => {
            if (res.status === 'success') {
                editor.setValue(res.code, -1);
            } else {
                alert('åŠ è½½æ–‡ä»¶å¤±è´¥ï¼');
            }
        });
}

// é¦–æ¬¡åŠ è½½æ–‡ä»¶åˆ—è¡¨
// refreshFileList();
// æ¯5ç§’åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
// setInterval(refreshFileList, 5000);

</script>
<script>
    loadCodeTree();
    setInterval(() => loadCodeTree(document.getElementById('treeSearch').value), 5000);
</script>
</body>
</html>
